generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "extensions"), vector]
}

model User {
  id             String                @id @default(uuid())
  email          String                @unique
  tier           UserTier              @default(free)
  createdAt      DateTime              @default(now()) @map("created_at")
  episodes       Episode[]
  feeds          Feed[]
  filteringStats FilteringStatistics[]
  questions      Question[]
  preferences    UserPreferences?

  @@map("users")
}

model Feed {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  url         String
  createdAt   DateTime  @default(now()) @map("created_at")
  category    String?
  description String?
  isPopular   Boolean   @default(false) @map("is_popular")
  name        String?
  articles    Article[]
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, url])
  @@map("feeds")
}

model Article {
  id              String                 @id @default(uuid())
  feedId          String                 @map("feed_id")
  title           String
  content         String
  publishedAt     DateTime?              @map("published_at")
  summary         String?
  embedding       Unsupported("vector")?
  createdAt       DateTime               @default(now()) @map("created_at")
  feed            Feed                   @relation(fields: [feedId], references: [id], onDelete: Cascade)
  episodeArticles EpisodeArticle[]

  @@unique([feedId, title])
  @@map("articles")
}

model Episode {
  id              String           @id @default(uuid())
  userId          String           @map("user_id")
  scriptText      String           @map("script_text")
  audioUrl        String           @map("audio_url")
  durationMinutes Int              @map("duration_minutes")
  createdAt       DateTime         @default(now()) @map("created_at")
  episodeArticles EpisodeArticle[]
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  questions       Question[]

  @@map("episodes")
}

model EpisodeArticle {
  episodeId String  @map("episode_id")
  articleId String  @map("article_id")
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  episode   Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  @@id([episodeId, articleId])
  @@map("episode_articles")
}

model Question {
  id           String   @id @default(uuid())
  episodeId    String   @map("episode_id")
  userId       String   @map("user_id")
  questionText String   @map("question_text")
  answerText   String   @map("answer_text")
  createdAt    DateTime @default(now()) @map("created_at")
  episode      Episode  @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("questions")
}

model AudioCache {
  id         String   @id @default(uuid())
  scriptHash String   @unique @map("script_hash")
  audioUrl   String   @map("audio_url")
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("audio_cache")
}

model UserPreferences {
  id                       String                 @id @default(uuid())
  userId                   String                 @unique @map("user_id")
  selectedTopics           String[]               @map("selected_topics")
  customKeywords           String[]               @map("custom_keywords")
  relevanceThreshold       Int                    @default(80) @map("relevance_threshold")
  interestProfileEmbedding Unsupported("vector")? @map("interest_profile_embedding")
  onboardingCompleted      Boolean                @default(false) @map("onboarding_completed")
  createdAt                DateTime               @default(now()) @map("created_at")
  updatedAt                DateTime               @updatedAt @map("updated_at")
  user                     User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model FilteringStatistics {
  id                  String   @id @default(uuid())
  userId              String   @map("user_id")
  date                DateTime @default(now())
  includedArticles    Int      @map("included_articles")
  filteredOutArticles Int      @map("filtered_out_articles")
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@map("filtering_statistics")
}

enum UserTier {
  free
  pro
}
